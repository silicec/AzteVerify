const { Events, AuditLogEvent } = require('discord.js');
const { executeQuery } = require('../database.js');

module.exports = {
    name: Events.GuildBanAdd,
    async execute(ban) {
        try {
            console.log(`Ban event detected in guild: ${ban.guild.name}, for user: ${ban.user.tag}`);

            // Wait briefly to ensure the audit log is updated
            await new Promise(resolve => setTimeout(resolve, 1000));

            console.log('Fetching the most recent audit log for a ban...');

            // Fetch the audit log entry for the ban
            const fetchedLogs = await ban.guild.fetchAuditLogs({
                limit: 1,
                type: AuditLogEvent.MemberBanAdd,
            });

            const banLog = fetchedLogs.entries.first();

            // Debug: Log the fetched audit log entry
            console.log('Fetched audit log entry:', banLog);

            // Check if a valid ban log is found
            if (!banLog) {
                console.log(`No audit log found for the ban in ${ban.guild.name}.`);
                return;
            }

            const { executor } = banLog; // The admin who performed the ban
            const adminUsername = executor.tag; // Get the username and discriminator (e.g., Admin#1234)

            console.log(`Ban executed by: ${adminUsername}`);

            // Log and update the admin_bans count in the database
            const query = `INSERT INTO ActivitateAdmin (admin_id, admin_bans) 
                           VALUES (?, 1) 
                           ON DUPLICATE KEY UPDATE admin_bans = admin_bans + 1`;

            console.log(`Executing SQL query: ${query} with adminUsername: ${adminUsername}`);

            await executeQuery(query, [adminUsername]);

            console.log(`Successfully logged the ban by ${executor.tag} in guild ${ban.guild.name}.`);

        } catch (error) {
            console.error('Error logging the ban:', error);
        }
    }
};
