const { Events, AuditLogEvent } = require('discord.js');
const { executeQuery } = require('../database.js');

module.exports = {
    name: Events.GuildBanAdd,
    console.log(`A ban was issued by ${ban.executor.tag}`);
    async execute(ban) {
        try {
            // Fetch the audit log entry for the ban
            const fetchedLogs = await ban.guild.fetchAuditLogs({
                limit: 1,
                type: AuditLogEvent.MemberBanAdd,
            });
            const banLog = fetchedLogs.entries.first();

            // Check if a valid ban log is found
            if (!banLog) return console.log(`No audit log found for the ban in ${ban.guild.name}.`);

            const { executor } = banLog; // The admin who performed the ban
            const adminUsername = executor.tag; // Get the username and discriminator (e.g., Admin#1234)

            // Log and update the admin_bans count in the database
            await executeQuery(
                `INSERT INTO ActivitateAdmin (admin_id, admin_bans) 
                 VALUES (?, 1) 
                 ON DUPLICATE KEY UPDATE admin_bans = admin_bans + 1`,
                [adminUsername]
            );

            console.log(`Logged a ban by ${executor.tag} in guild ${ban.guild.name}.`);

        } catch (error) {
            console.error('Error logging the ban:', error);
        }
    }
};
